#### 内核中断概述

**什么是中断？**

中断是CPU上当前正在执行的程序外部的事件，例如键盘输入或网络数据包到达。当这些事件发生时，CPU正在执行一些与该事件完全无关的随机程序。与事件相关的硬件设备（例如键盘或网络设备）会通知处理器，以便可以对其进行处理。这种通知处理器有关事件的机制称为中断。顾名思义，它会中断处理器的当前执行，以通知处理器有关未决事件的信息。

**设备如何中断处理器？**

在像8259这样的旧式系统中，设备可以断定一些固定线路，使处理器知道事件已经发生。8259上有8条支持的中断线。断言的中断线将使处理器知道断言的中断类型。[PIC 8259 Wiki](https://en.wikipedia.org/wiki/Intel_8259)是有关8259控制器的更多信息的很好的来源 。

**什么是共享中断？**

由于只有固定数量的中断线，如果需要更多的设备支持怎么办？一种可能的解决方案是某些中断线必须由多个设备共享。当共享中断线时，共享中断线的不同设备必须向处理器提供一些唯一的信息，以使处理器能够确定哪个设备断言了中断线。如果不共享中断线，则无需提供此信息。 

**处理器做什么？**

当处理器被中断时，它正在执行某些程序。处理器需要先保存当前正在执行的程序的上下文，然后它才能响应生成中断的事件。保存程序上下文后，它会为生成中断的事件调用中断处理程序。

**处理器如何知道要运行哪个中断处理程序？**

系统启动时，中断被禁用。内核在启动时设置了一些中断门。这指向需要调用的中断处理程序。确切的过程是特定于处理器的。发生中断时，处理器将禁用中断，并根据中断描述符表执行相应的中断处理程序。 

**中断处理程序做什么？**

发生中断时，将执行通用的中断处理程序代码。通用中断处理程序首先保存正在运行的进程的上下文。这包括指令指针`（IP）`，堆栈指针和其他需要再次恢复该过程的寄存器。此上下文通常保存在堆栈中。然后将上下文更改为中断堆栈。通用中断处理程序使用此中断堆栈进行处理和参数传递。有关内核堆栈的信息，请参见 [x86的内核堆栈](https://www.kernel.org/doc/Documentation/x86/kernel-stacks)。

通用中断处理程序代码更改中断级别以禁用所有低优先级中断，而不是当前正在处理的中断。只有高优先级的中断才能中断中断处理程序。这可能会导致嵌套中断。然后，通用中断处理程序调用特定于当前中断的特定中断处理程序，例如键盘中断或网络中断。因此，例如对于`e1000e`设备调用了`e1000_intr`。该处理程序执行的任务是特定于设备的，但是执行的一般任务很少，例如确定中断原因。中断处理程序的一项重要任务是尽快重新启用中断。中断处理程序通常会提供尽可能多的功能，以便稍后由下半部分处理。下半部分在启用中断的情况下执行。这样可以实现更好的系统响应和更少的延迟。为了通知下半部分有关挂起的中断，中断处理程序将引发`softirq`。这基本上将轮询添加到队列中，并且从下半部分调用轮询方法。除非允许嵌套，否则在下半部分执行期间将禁用`Softirq`。某些中断可能是共享的。在某些情况下，将调用特殊的内核线程来处理`softirq`。某些中断可能是共享的。在某些情况下，将调用特殊的内核线程来处理`softirq`。某些中断可能是共享的。在某些情况下，将调用特殊的内核线程来处理`softirq`。